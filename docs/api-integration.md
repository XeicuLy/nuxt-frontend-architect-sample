# ğŸ”— APIçµ±åˆã‚’ã¯ã˜ã‚ã‚ˆã†

åˆå­¦è€…å‘ã‘ã«ã€ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® **API-First** é–‹ç™ºã«ã¤ã„ã¦ã€æ—¥å¸¸çš„ãªä¾‹ãˆè©±ã§åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“® éƒµä¾¿ã‚·ã‚¹ãƒ†ãƒ ã«ä¾‹ãˆã‚‹API-Firsté–‹ç™º

### API-Firstã£ã¦ä½•ï¼Ÿ

**API-Firsté–‹ç™º**ã‚’éƒµä¾¿ã‚·ã‚¹ãƒ†ãƒ ã«ä¾‹ãˆã¦ã¿ã¾ã—ã‚‡ã†ï¼š

#### ğŸ¤” å¾“æ¥ã®ã‚„ã‚Šæ–¹ï¼ˆå•é¡Œã‚ã‚Šï¼‰

```
1. ğŸ‘¨â€ğŸ’» Aã•ã‚“: æ‰‹ç´™ã‚’æ›¸ã
2. ğŸ‘©â€ğŸ’» Bã•ã‚“: è¿”äº‹ã‚’æ›¸ã
3. ğŸ˜° å•é¡Œç™ºç”Ÿ: ã€Œã©ã†ã‚„ã£ã¦é€ã‚ã†ï¼Ÿä½æ‰€ã®æ›¸ãæ–¹ã¯ï¼Ÿã€
4. ğŸ”„ ã‚„ã‚Šç›´ã—: æ‰‹ç´™ã‚’æ›¸ãç›´ã—
```

#### âœ… API-Firstã®ã‚„ã‚Šæ–¹ï¼ˆã‚¹ãƒãƒ¼ãƒˆï¼‰

```
1. ğŸ“‹ æœ€åˆã«éƒµä¾¿ãƒ«ãƒ¼ãƒ«ã‚’æ±ºã‚ã‚‹
   - ä½æ‰€ã®æ›¸ãæ–¹
   - å°ç­’ã®ã‚µã‚¤ã‚º
   - åˆ‡æ‰‹ã®ç¨®é¡
2. ğŸ‘¨â€ğŸ’» Aã•ã‚“: ãƒ«ãƒ¼ãƒ«ã«å¾“ã£ã¦æ‰‹ç´™ã‚’æ›¸ã
3. ğŸ‘©â€ğŸ’» Bã•ã‚“: åŒã˜ãƒ«ãƒ¼ãƒ«ã§è¿”äº‹ã‚’æ›¸ã
4. ğŸ‰ å®Œç’§ã«å±Šãï¼
```

### ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§è¨€ã†ã¨...

**éƒµä¾¿ãƒ«ãƒ¼ãƒ«** = **APIä»•æ§˜ï¼ˆOpenAPIï¼‰**

- ã©ã‚“ãªãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ã‹
- ã©ã‚“ãªå½¢å¼ã§é€ã‚‹ã‹
- ã©ã‚“ãªè¿”äº‹ãŒæ¥ã‚‹ã‹

**æ‰‹ç´™** = **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰**

- APIä»•æ§˜ã«å¾“ã£ã¦ä½œã‚‹
- ãŠäº’ã„ãŒç†è§£ã§ãã‚‹å½¢å¼

### ãªãœAPI-FirstãŒè‰¯ã„ã®ï¼Ÿ

#### ğŸ¯ é–“é•ã„ãŒæ¸›ã‚‹

- æœ€åˆã«ãƒ«ãƒ¼ãƒ«ã‚’æ±ºã‚ã‚‹ã®ã§ã€å‹˜é•ã„ãŒãªã„
- è‡ªå‹•ã§ãƒã‚§ãƒƒã‚¯ã—ã¦ãã‚Œã‚‹

#### âš¡ ä½œæ¥­ãŒæ—©ããªã‚‹

- æ‰‹å‹•ã§å‹ã‚’ä½œã‚‹å¿…è¦ãŒãªã„
- ãƒ•ãƒ­ãƒ³ãƒˆã¨ãƒãƒƒã‚¯ã‚’åŒæ™‚ã«é–‹ç™ºã§ãã‚‹

#### ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè‡ªå‹•ã§ä½œã‚‰ã‚Œã‚‹

- APIã®ä½¿ã„æ–¹ãŒè‡ªå‹•ã§èª¬æ˜ã•ã‚Œã‚‹
- æ–°ã—ã„äººã‚‚ã™ãã«ç†è§£ã§ãã‚‹

## ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®APIå®Ÿè£…

### Health API ã®å®šç¾©

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ **Health API** ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼š

```typescript
// server/api/schema/health.tsï¼ˆå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
import { z } from '@hono/zod-openapi';
import { ERROR_TYPES } from '#shared/constants/errorCode';

/**
 * ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯APIã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒ
 * ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’æä¾›
 */
export const healthQuerySchema = z.object({
  simulate: z.enum(['error', 'timeout']).optional().openapi({
    description: 'ã‚¨ãƒ©ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã€‚error=SVR_002, timeout=NET_002',
    example: 'error',
  }),
});

/**
 * ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æˆåŠŸæ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ã‚­ãƒ¼ãƒ
 * ã‚·ã‚¹ãƒ†ãƒ ã®ç¨¼åƒçŠ¶æ³ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å«ã‚€
 */
export const healthResponseSchema = z.object({
  status: z.string().openapi({ example: 'ok' }),
  timestamp: z.iso.datetime().openapi({ example: new Date().toISOString() }),
});

/**
 * ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ã‚­ãƒ¼ãƒ
 * çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä½“ç³»ã«æº–æ‹ ã—ãŸã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’æä¾›
 */
export const healthErrorSchema = z.object({
  error: z.string().openapi({ example: 'Service temporarily unavailable' }),
  errorCode: z.enum(Object.values(ERROR_TYPES)).openapi({
    example: 'SVR_002',
    description:
      'çµ±ä¸€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: NET_xxx(ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯), SVR_xxx(ã‚µãƒ¼ãƒãƒ¼), VAL_xxx(ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³), AUTH_xxx(èªè¨¼), UNK_xxx(ä¸æ˜)',
  }),
  timestamp: z.iso.datetime().openapi({ example: new Date().toISOString() }),
});
```

### çµ±ä¸€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä½“ç³»

```typescript
// shared/constants/errorCode.ts
export const ERROR_TYPES = {
  // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–¢é€£ã‚¨ãƒ©ãƒ¼ (NET_xxx)
  CONNECTION_ERROR: 'NET_001', // æ¥ç¶šã‚¨ãƒ©ãƒ¼
  TIMEOUT_ERROR: 'NET_002', // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼
  NETWORK_DISCONNECTED: 'NET_003', // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­
  DNS_RESOLUTION_ERROR: 'NET_004', // DNSè§£æ±ºã‚¨ãƒ©ãƒ¼

  // ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼ (SVR_xxx)
  INTERNAL_SERVER_ERROR: 'SVR_001', // å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼
  SERVICE_UNAVAILABLE: 'SVR_002', // ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ä¸å¯
  DATABASE_ERROR: 'SVR_003', // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼
  EXTERNAL_API_ERROR: 'SVR_004', // å¤–éƒ¨APIé€šä¿¡ã‚¨ãƒ©ãƒ¼
  FILE_OPERATION_ERROR: 'SVR_005', // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚¨ãƒ©ãƒ¼

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ (VAL_xxx)
  VALIDATION_MISSING_PARAMS: 'VAL_001', // å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸è¶³
  VALIDATION_INVALID_FORMAT: 'VAL_002', // ä¸æ­£ãªå½¢å¼
  VALIDATION_OUT_OF_RANGE: 'VAL_003', // å€¤ã®ç¯„å›²å¤–
  VALIDATION_LENGTH_EXCEEDED: 'VAL_004', // æ–‡å­—æ•°åˆ¶é™è¶…é

  // èªè¨¼ãƒ»èªå¯ã‚¨ãƒ©ãƒ¼ (AUTH_xxx)
  AUTH_FAILED: 'AUTH_001', // èªè¨¼å¤±æ•—
  AUTH_INSUFFICIENT_PERMISSIONS: 'AUTH_002', // æ¨©é™ä¸è¶³
  AUTH_SESSION_EXPIRED: 'AUTH_003', // ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œ
  AUTH_ACCESS_DENIED: 'AUTH_004', // ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦

  // ä¸æ˜ãƒ»äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ (UNK_xxx)
  UNEXPECTED_ERROR: 'UNK_001', // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
  SYSTEM_ERROR: 'UNK_002', // ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼
  PROCESSING_INTERRUPTED: 'UNK_003', // å‡¦ç†ä¸­æ–­
  UNKNOWN_STATE: 'UNK_004', // ä¸æ˜ãªçŠ¶æ…‹
} as const;

/**
 * ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 * @param errorCode - ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
 * @param customMessage - ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆçœç•¥æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼‰
 * @param timestamp - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆçœç•¥æ™‚ã¯ç¾åœ¨æ™‚åˆ»ã‚’ä½¿ç”¨ï¼‰
 * @returns ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
export const createErrorResponse = (errorCode: ErrorCode, customMessage?: string, timestamp?: string) => ({
  error: customMessage || ERROR_MESSAGES[errorCode],
  errorCode,
  timestamp: timestamp || new Date().toISOString(),
});
```

### APIå®Ÿè£…ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¯¾å¿œï¼‰

```typescript
// server/api/routes/health.tsï¼ˆå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
import { createRoute, type OpenAPIHono } from '@hono/zod-openapi';
import { createErrorResponse, ERROR_TYPES } from '#shared/constants/errorCode';
import { HTTP_STATUS } from '#shared/constants/httpStatus';
import { healthErrorSchema, healthQuerySchema, healthResponseSchema } from '../schema/health';

export const healthHandler = (app: OpenAPIHono) => {
  app.openapi(healthRoute, async (context) => {
    const { simulate } = context.req.valid('query');

    // ã‚¨ãƒ©ãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
    if (simulate === 'error') {
      const errorResponse = createErrorResponse(
        ERROR_TYPES.SERVICE_UNAVAILABLE, // ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ä¸å¯
        'Service temporarily unavailable for maintenance',
      );
      return context.json(errorResponse, HTTP_STATUS.INTERNAL_SERVER_ERROR);
    }

    if (simulate === 'timeout') {
      const errorResponse = createErrorResponse(
        ERROR_TYPES.TIMEOUT_ERROR, // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼
        'Health check request timeout occurred',
      );
      return context.json(errorResponse, HTTP_STATUS.REQUEST_TIMEOUT);
    }

    // å®Ÿéš›ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
    try {
      await performHealthChecks();
      return context.json({ status: 'ok', timestamp: new Date().toISOString() }, HTTP_STATUS.OK);
    } catch (error) {
      // ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã«å¿œã˜ãŸé©åˆ‡ãªã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰è¿”å´
      const errorCode = classifyHealthCheckError(error);
      const errorResponse = createErrorResponse(errorCode, 'Health check failed');
      const httpStatus = errorCode.startsWith('SVR_')
        ? HTTP_STATUS.INTERNAL_SERVER_ERROR
        : HTTP_STATUS.SERVICE_UNAVAILABLE;

      return context.json(errorResponse, httpStatus);
    }
  });
};
```

## å‹å®šç¾©ã®è‡ªå‹•ç”Ÿæˆ

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

```typescript
// openapi-ts.config.ts
import { defineConfig } from '@hey-api/openapi-ts';

export default defineConfig({
  input: './public/openapi.yaml',
  output: './shared/types/api',
  plugins: ['@hey-api/typescript', { name: 'zod', exportFromIndex: true }],
});
```

### ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

```
shared/types/api/
â”œâ”€â”€ index.ts       # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
â”œâ”€â”€ types.gen.ts   # TypeScriptå‹å®šç¾©
â””â”€â”€ zod.gen.ts     # Zodã‚¹ã‚­ãƒ¼ãƒ
```

### å‹å®šç¾©ç”Ÿæˆã‚³ãƒãƒ³ãƒ‰

**ğŸ“ é‡è¦**: å‹å®šç¾©ç”Ÿæˆã¯2ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿè¡Œã•ã‚Œã¾ã™

```bash
# 1. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
pnpm dev

# 2. åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å‹å®šç¾©ç”Ÿæˆ
pnpm generate-types
```

**ğŸ”„ å†…éƒ¨å‹•ä½œ**:

1. **OpenAPIã‚¹ãƒšãƒƒã‚¯åé›†**: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ `/api/openapi.yaml` ã‚’å–å¾—ã—ã¦ `public/openapi.yaml` ã«ä¿å­˜
2. **å‹å®šç¾©ç”Ÿæˆ**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ `shared/types/api/` ã«å‹ã‚’ç”Ÿæˆ
3. **ã‚³ãƒ¼ãƒ‰æ•´å½¢**: ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•æ•´å½¢

## å‹å®‰å…¨ãªAPIé€šä¿¡ã®å®Ÿè£…

### ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ã®ä½¿ç”¨

```typescript
// app/services/health.ts
import { type GetApiHealthResponse, zGetApiHealthResponse } from '#shared/types/api';

export const getHealthApi = async (): Promise<GetApiHealthResponse> => {
  // 1. HTTPé€šä¿¡
  const response = await $fetch<GetApiHealthResponse>('/api/health', {
    method: 'GET',
  });

  // 2. ãƒ©ãƒ³ã‚¿ã‚¤ãƒ æ¤œè¨¼ï¼ˆZodã‚¹ã‚­ãƒ¼ãƒï¼‰
  return zGetApiHealthResponse.parse(response);
};
```

### TanStack Query ã¨ã®çµ±åˆ

```typescript
// app/queries/useHealthQuery.ts
import { useQuery } from '@tanstack/vue-query';
import { getHealthApi } from '~/services/health';

export const useHealthQuery = () => {
  const healthQuery = useQuery({
    queryKey: ['health'] as const,
    queryFn: getHealthApi,
  });

  return { healthQuery };
};
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®ä½¿ç”¨

```typescript
// app/composables/useHealth/useHealthAdapter.ts
export const useHealthAdapter = () => {
  const { healthQuery } = useHealthQuery();
  const { isLoading, data, suspense: getHealthData } = healthQuery;

  const healthStatusData = computed(() => ({
    healthStatus: data.value?.status ?? '-',
    healthTimestamp: data.value?.timestamp ?? '-',
  }));

  return { isLoading, healthStatusData, getHealthData };
};
```

## API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç¢ºèª

### Swagger UI ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹

é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾Œã€ä»¥ä¸‹ã®URLã§APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªã§ãã¾ã™ï¼š

- **Swagger UI**: http://localhost:3000/api/swagger
- **OpenAPIä»•æ§˜**: http://localhost:3000/api/openapi.yaml

### API ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

Swagger UIç”»é¢ã§å®Ÿéš›ã«APIã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ï¼š

1. http://localhost:3000/api/swagger ã«ã‚¢ã‚¯ã‚»ã‚¹
2. Health Check APIã‚’é¸æŠ
3. ã€ŒTry it outã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ã‚¨ãƒ©ãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ:
   - `simulate` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã« `error` ã‚’å…¥åŠ› â†’ `SVR_002` ã‚¨ãƒ©ãƒ¼
   - `simulate` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã« `timeout` ã‚’å…¥åŠ› â†’ `NET_002` ã‚¨ãƒ©ãƒ¼
   - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãªã—ã§å®Ÿè¡Œ â†’ æ­£å¸¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹
5. ã€ŒExecuteã€ãƒœã‚¿ãƒ³ã§APIã‚’å®Ÿè¡Œ

### ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§ã®ãƒ†ã‚¹ãƒˆ

```bash
# æ­£å¸¸ã‚±ãƒ¼ã‚¹
curl "http://localhost:3000/api/health"

# ã‚¨ãƒ©ãƒ¼ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
curl "http://localhost:3000/api/health?simulate=error"
curl "http://localhost:3000/api/health?simulate=timeout"
```

### æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹

**æ­£å¸¸æ™‚**:

```json
{
  "status": "ok",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

**ã‚¨ãƒ©ãƒ¼æ™‚**:

```json
{
  "error": "Service temporarily unavailable for maintenance",
  "errorCode": "SVR_002",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã§çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’æä¾›ã™ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼š

```typescript
// server/api/middleware/errorHandler.ts

/**
 * Honoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
 * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒã—ã€çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´
 */
export const errorHandlerMiddleware = async (context: Context, next: Next) => {
  try {
    await next();
  } catch (error) {
    // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å®Ÿè¡Œ
    const errorInfo = createErrorInfo(error, context);
    const errorCode = classifyError(error);
    const httpStatus = getHttpStatusFromErrorCode(errorCode);

    // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ãƒ­ã‚°å‡ºåŠ›
    consola.error('Unhandled error in API endpoint:', errorInfo);

    // çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆ
    const errorResponse = createErrorResponse(errorCode);
    return context.json(errorResponse, httpStatus);
  }
};
```

### ã‚¨ãƒ©ãƒ¼åˆ†é¡ã‚·ã‚¹ãƒ†ãƒ 

```typescript
/**
 * ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ±ºå®šã™ã‚‹é–¢æ•°
 * @param error - åˆ†é¡å¯¾è±¡ã®ã‚¨ãƒ©ãƒ¼
 * @returns é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
 */
const classifyError = (error: unknown): ErrorCode => {
  if (!(error instanceof Error)) {
    return ERROR_TYPES.UNEXPECTED_ERROR;
  }

  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼åˆ†é¡
  const errorPatterns = [
    { patterns: ['timeout', 'TIMEOUT'], errorCode: ERROR_TYPES.TIMEOUT_ERROR },
    { patterns: ['network', 'NETWORK'], errorCode: ERROR_TYPES.CONNECTION_ERROR },
    { patterns: ['database', 'DB'], errorCode: ERROR_TYPES.DATABASE_ERROR },
    { patterns: ['validation', 'invalid'], errorCode: ERROR_TYPES.VALIDATION_INVALID_FORMAT },
    { patterns: ['file', 'FILE'], errorCode: ERROR_TYPES.FILE_OPERATION_ERROR },
  ];

  // ZodErrorã®ç‰¹åˆ¥ãªå‡¦ç†
  if (error instanceof ZodError) {
    return ERROR_TYPES.VALIDATION_INVALID_FORMAT;
  }

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹åˆ†é¡
  const matchedPattern = errorPatterns.find(({ patterns }) =>
    patterns.some((pattern) => error.message.includes(pattern)),
  );

  return matchedPattern?.errorCode ?? ERROR_TYPES.INTERNAL_SERVER_ERROR;
};
```

### HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°

```typescript
export const getHttpStatusFromErrorCode = (errorCode: ErrorCode): number => {
  // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ â†’ 408 (Request Timeout) ã¾ãŸã¯ 503 (Service Unavailable)
  if (errorCode.startsWith('NET_')) {
    return errorCode === ERROR_TYPES.TIMEOUT_ERROR ? 408 : 503;
  }

  // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ â†’ 500 (Internal Server Error) ã¾ãŸã¯ 503 (Service Unavailable)
  if (errorCode.startsWith('SVR_')) {
    return errorCode === ERROR_TYPES.SERVICE_UNAVAILABLE ? 503 : 500;
  }

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ â†’ 400 (Bad Request)
  if (errorCode.startsWith('VAL_')) {
    return 400;
  }

  // èªè¨¼ãƒ»èªå¯ã‚¨ãƒ©ãƒ¼ â†’ 401 (Unauthorized) ã¾ãŸã¯ 403 (Forbidden)
  if (errorCode.startsWith('AUTH_')) {
    const authUnauthorizedCodes = [ERROR_TYPES.AUTH_FAILED, ERROR_TYPES.AUTH_SESSION_EXPIRED];
    return authUnauthorizedCodes.includes(errorCode) ? 401 : 403;
  }

  // ä¸æ˜ã‚¨ãƒ©ãƒ¼ â†’ 500 (Internal Server Error)
  return 500;
};
```

## JSDocãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### é©åˆ‡ãªJSDocè¨˜è¿°ä¾‹

```typescript
/**
 * ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
 * ãƒ¡ãƒ¢ãƒªã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
 * @throws {Error} ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ãŸå ´åˆ
 */
const performHealthChecks = async () => {
  // å®Ÿè£…...
};

/**
 * ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
 * @returns ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ï¼ˆMBï¼‰ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼æƒ…å ±
 */
const checkMemoryUsage = (): HealthCheckResult<number> => {
  // å®Ÿè£…...
};

/**
 * ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 * @param errorCode - ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
 * @param customMessage - ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆçœç•¥æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼‰
 * @param timestamp - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆçœç•¥æ™‚ã¯ç¾åœ¨æ™‚åˆ»ã‚’ä½¿ç”¨ï¼‰
 * @returns ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
export const createErrorResponse = (errorCode: ErrorCode, customMessage?: string, timestamp?: string) => {
  // å®Ÿè£…...
};
```

### é¿ã‘ã‚‹ã¹ãè¡¨ç¾

- æŠ€è¡“çš„ã«ä¸æ­£ç¢ºãªç”¨èªï¼ˆã€Œãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°é¢¨ã€ã€Œé–¢æ•°å‹ãƒ‘ãƒ©ãƒ€ã‚¤ãƒ ç”¨ã€ãªã©ï¼‰
- å®Ÿè£…è©³ç´°ã§ã¯ãªãã€æ©Ÿèƒ½ã®ç›®çš„ã‚’æ˜ç¢ºã«èª¬æ˜ã™ã‚‹

## é–‹ç™ºãƒ•ãƒ­ãƒ¼ã®åŸºæœ¬

### æ–°ã—ã„APIè¿½åŠ ã®æ‰‹é †

1. **ã‚¹ã‚­ãƒ¼ãƒå®šç¾©**: `server/api/schema/` ã§Zodã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©
2. **ãƒ«ãƒ¼ãƒˆå®Ÿè£…**: `server/api/routes/` ã§APIã‚’å®Ÿè£…
3. **å‹å®šç¾©ç”Ÿæˆ**: `pnpm generate-types` ã§å‹ã‚’ç”Ÿæˆ
4. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…**: `app/services/` ã§APIé€šä¿¡ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½œæˆ

## å­¦ç¿’ã®ãƒã‚¤ãƒ³ãƒˆ

### ğŸ”° åˆå­¦è€…ãŒè¦šãˆã‚‹ã“ã¨

1. **API-First**: ä»•æ§˜ã‚’å…ˆã«æ±ºã‚ã¦ã‹ã‚‰å®Ÿè£…ã™ã‚‹
2. **å‹å®‰å…¨æ€§**: TypeScriptã§å‹ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
3. **è‡ªå‹•ç”Ÿæˆ**: æ‰‹å‹•ä½œæ¥­ã‚’æ¸›ã‚‰ã—ã¦åŠ¹ç‡åŒ–

### âš¡ å®Ÿè·µã®ã‚³ãƒ„

- APIä»•æ§˜ã‚’å¤‰æ›´ã—ãŸã‚‰ `pnpm generate-types` ã‚’å¿˜ã‚Œãšã«å®Ÿè¡Œ
- Swagger UIã§APIã®å‹•ä½œã‚’ç¢ºèª
- Zodã‚¹ã‚­ãƒ¼ãƒã§ãƒ©ãƒ³ã‚¿ã‚¤ãƒ æ¤œè¨¼ã‚’æ´»ç”¨

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- ğŸ“Š [çŠ¶æ…‹ç®¡ç†](./state-management.md) - TanStack Queryã¨ã®é€£æº
- ğŸ§ª [ãƒ†ã‚¹ãƒˆ](./testing.md) - APIãƒ†ã‚¹ãƒˆã®åŸºæœ¬
- ğŸ’» [é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼](./development.md) - åŠ¹ç‡çš„ãªé–‹ç™ºæ‰‹æ³•
